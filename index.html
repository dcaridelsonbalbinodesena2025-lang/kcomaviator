<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Autom√°tica - v2</title>
    <style>
        :root { --verde: #2ecc71; --vermelho: #e74c3c; --azul: #3498db; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #0b0b0b; color: white; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        .visor-sinal { width: 100%; max-width: 450px; background: #151515; border: 2px solid #333; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .status-msg { font-size: 1.2rem; font-weight: bold; color: #888; }
        .grade { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; max-width: 450px; margin-bottom: 20px; }
        .vela { background: #222; height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; }
        .v-azul { border: 2px solid #005f87; color: #00d2ff; }
        .v-roxo { border: 2px solid #6441a5; color: #d59fff; }
        .v-rosa { border: 2px solid #bf279b; color: #ff9de2; }
        .area-cadastro { width: 100%; max-width: 450px; background: #1c1c1c; border-radius: 15px; padding: 20px; border: 1px solid #444; }
        input { width: 60%; padding: 12px; border-radius: 8px; border: 1px solid #555; background: #000; color: white; text-transform: uppercase; }
        button { padding: 12px 20px; background: var(--azul); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body onload="iniciar()">
    <div class="visor-sinal">
        <div id="texto-status" class="status-msg">üîç AGUARDANDO PRIMEIRA VELA...</div>
    </div>
    <div class="grade" id="grade-velas"></div>
    <div class="area-cadastro">
        <h3 style="font-size:0.9rem; margin-bottom:10px;">CADASTRAR ESTRAT√âGIA:</h3>
        <input type="text" id="meu-padrao" placeholder="EX: PPG">
        <button onclick="cadastrar()">SALVAR</button>
        <div id="lista" style="margin-top:10px; font-size:0.8rem; color:var(--azul);"></div>
    </div>

<script>
    let historicoVelas = [];
    let padroesUsuario = [];
    let ultimoID = 0;

    async function buscarDados() {
        try {
            // O 'cache: no-store' obriga a pegar a vela que saiu agora no TipMiner
            const res = await fetch('https://kcomaviator.onrender.com/ultimo', { cache: 'no-store' });
            const data = await res.json();

            if (data.valor > 0 && data.valor !== ultimoID) {
                const tipo = data.valor >= 2.0 ? 'G' : 'P';
                let cor = data.valor < 2.0 ? 'v-azul' : (data.valor < 10 ? 'v-roxo' : 'v-rosa');
                
                historicoVelas.unshift({v: data.valor.toFixed(2), t: tipo, c: cor});
                if(historicoVelas.length > 21) historicoVelas.pop();
                
                ultimoID = data.valor;
                document.getElementById('texto-status').innerText = "üü¢ VELA RECEBIDA: " + data.valor + "x";
                renderizar();
                checar();
            }
        } catch (e) { document.getElementById('texto-status').innerText = "üî¥ ERRO NO RENDER"; }
    }

    function cadastrar() {
        const val = document.getElementById('meu-padrao').value.toUpperCase();
        if(val) { padroesUsuario.push(val); document.getElementById('lista').innerText = "ATIVOS: " + padroesUsuario.join(" | "); }
    }

    function checar() {
        const seq = historicoVelas.map(x => x.t).join('');
        padroesUsuario.forEach(p => {
            if(seq.startsWith(p)) {
                document.getElementById('texto-status').innerHTML = "üö® ENTRADA CONFIRMADA!";
                document.getElementById('texto-status').style.color = "#2ecc71";
            }
        });
    }

    function renderizar() {
        const g = document.getElementById('grade-velas');
        g.innerHTML = '';
        for(let i=0; i<21; i++) {
            const v = historicoVelas[i];
            g.innerHTML += `<div class="vela ${v ? v.c : ''}">${v ? v.v : ''}</div>`;
        }
    }

    function iniciar() { renderizar(); setInterval(buscarDados, 3000); }
</script>
</body>
</html>
